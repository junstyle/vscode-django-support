{
  "version": 3,
  "sources": ["../src/extension.ts", "../src/formatting.ts", "../src/virtualDocument.ts"],
  "sourcesContent": ["import { commands, CompletionList, ExtensionContext, Hover, languages, TextEdit, Range, DiagnosticCollection } from 'vscode';\nimport { formatting } from './formatting';\nimport { clearVirtualDocumentContents, createVirtualDoc, registerTextDocumentEvents } from './virtualDocument';\n\nconst languageIds = [\"django-html\"];\nlet diagnosticCollection: DiagnosticCollection;\n\nexport function activate(context: ExtensionContext) {\n\n\tregisterTextDocumentEvents(context, languageIds);\n\n\tdiagnosticCollection = languages.createDiagnosticCollection('django');\n\tcontext.subscriptions.push(diagnosticCollection);\n\n\tcontext.subscriptions.push(languages.registerDocumentFormattingEditProvider('django-html', {\n\t\tprovideDocumentFormattingEdits: async (document, options, token) => {\n\t\t\tconst otext = document.getText();\n\t\t\tif (!otext) { return; }\n\t\t\tlet newDoc = document;\n\t\t\t// try {\n\t\t\t// const vdocUri = createVirtualDoc(document);\n\t\t\t// \tconst textEdits = await commands.executeCommand<TextEdit[]>(\"vscode.executeFormatDocumentProvider\", vdocUri, options);\n\t\t\t// \tlet ntext = '';\n\t\t\t// \tlet start = 0;\n\t\t\t// \tfor (let i = 0; i < textEdits.length; i++) {\n\t\t\t// \t\tconst te = textEdits[i];\n\t\t\t// \t\tntext += otext.slice(start, document.offsetAt(te.range.start)) + te.newText;\n\t\t\t// \t\tstart = document.offsetAt(te.range.end);\n\t\t\t// \t}\n\t\t\t// \tntext += otext.slice(start);\n\t\t\t// \tnewDoc = { uri: document.uri, getText() { return ntext; } };\n\t\t\t// } catch (err) {\n\t\t\t// \tconsole.log(err);\n\t\t\t// \tnewDoc = document;\n\t\t\t// }\n\n\t\t\tconst text = formatting(newDoc, diagnosticCollection);\n\t\t\tif (text && text != otext) {\n\t\t\t\tconst range = new Range(document.positionAt(0), document.positionAt(otext.length));\n\t\t\t\treturn [new TextEdit(range, text)];\n\t\t\t} else {\n\t\t\t\treturn [];\n\t\t\t}\n\t\t},\n\t}));\n\n\tcontext.subscriptions.push(languages.registerCompletionItemProvider(languageIds, {\n\t\tprovideCompletionItems: async (document, position, token, context) => {\n\t\t\tconst vdocUri = createVirtualDoc(document);\n\t\t\treturn await commands.executeCommand<CompletionList>(\n\t\t\t\t'vscode.executeCompletionItemProvider',\n\t\t\t\tvdocUri,\n\t\t\t\tposition,\n\t\t\t\tcontext.triggerCharacter\n\t\t\t);\n\t\t},\n\t}, '.', '(', ':', '<'));\n\tcontext.subscriptions.push(languages.registerHoverProvider(languageIds, {\n\t\tprovideHover: async (document, position, token) => {\n\t\t\tconst vdocUri = createVirtualDoc(document);\n\t\t\tconst hs = await commands.executeCommand<Hover[]>(\n\t\t\t\t'vscode.executeHoverProvider',\n\t\t\t\tvdocUri,\n\t\t\t\tposition\n\t\t\t);\n\t\t\treturn hs?.[0];\n\t\t}\n\t}));\n}\n\nexport function deactivate(): Thenable<void> | undefined {\n\tclearVirtualDocumentContents();\n\treturn undefined;\n}\n", "import { format, Options, ParserOptions, resolveConfig } from 'prettier';\nimport { Diagnostic, DiagnosticCollection, Range, TextDocument } from 'vscode';\nimport * as htmlPlugin from 'prettier/parser-html';\nimport * as djangoPlugin from 'prettier-plugin-django';\n\nexport function formatting(document: TextDocument, diagnosticCollection?: DiagnosticCollection): string {\n\tconst options = {\n\t\t\"tabWidth\": 2,\n\t\t\"printWidth\": 5000,\n\t\t\"semi\": false,\n\t\t\"singleQuote\": true,\n\t\t\"trailingComma\": \"none\",\n\n\t\t\"twigPrintWidth\": 5000,\n\t\t\"twigMultiTags\": [\n\t\t\t\"with,endwith\"\n\t\t],\n\t\t\"twigAlwaysBreakObjects\": false,\n\t\t\"twigSingleQuote\": true,\n\t\t// \"overrides\": [\n\t\t// \t{\n\t\t// \t\t\"files\": [\n\t\t// \t\t\t\"*.django\",\n\t\t// \t\t\tdocument.uri.fsPath\n\t\t// \t\t],\n\t\t// \t\t\"options\": {\n\t\t// \t\t}\n\t\t// \t}\n\t\t// ],\n\t\t\"parser\": \"melody\",\n\t\t// \"plugins\": [\n\t\t// \t\"D:/npm/global/node_modules/prettier-plugin-django\"\n\t\t// ]\n\t\t\"plugins\": [],\n\t\t\"htmlWhitespaceSensitivity\": \"ignore\",\n\t\t\"twigPrintEmbedElements\": false,\n\t};\n\tObject.assign(options, resolveConfig.sync(document.uri.fsPath) ?? []);\n\toptions.twigSingleQuote = true;\n\toptions.plugins = [djangoPlugin];\n\toptions.parser = \"melody\";\n\toptions.htmlWhitespaceSensitivity = 'ignore';\n\n\tconst doc = { text: document.getText() };\n\ttry {\n\t\tdoc.text = format(doc.text, options as Options);\n\t\tif (!doc.text) {\n\t\t\tthrow new Error('django-html: formatting failed');\n\t\t}\n\n\t\t//if use `prettier-plugin-django`, can't get the error tips, so don't use it\n\t\tformatStyleAndScript(doc, options as Options)\n\t\tdiagnosticCollection?.clear()\n\t} catch (error) {\n\t\tif (diagnosticCollection && error.loc) {\n\t\t\tdiagnosticCollection.clear();\n\t\t\tconst loc = error.loc\n\t\t\tif (!loc.end) {\n\t\t\t\tloc.end = { line: loc.start.line, column: loc.start.column + 1 };\n\t\t\t}\n\t\t\tlet line = loc.start.line - 1, col = loc.start.column - 1;\n\t\t\tlet line2 = loc.end.line - 1, col2 = loc.end.column - 1;\n\t\t\tlet range = new Range(line, col, line2, col2);\n\t\t\tsetTimeout(() => diagnosticCollection.set(document.uri, [new Diagnostic(range, error.message.split(' \\t ')[0].split('\\n')[0], 0)]), 250);\n\t\t}\n\t}\n\treturn doc.text;\n}\n\nfunction formatStyleAndScript(doc: { text: string }, options: Options) {\n\tlet indent = '  '\n\tif (options.useTabs) {\n\t\tindent = '\\t'\n\t} else {\n\t\tif (options.tabWidth) {\n\t\t\tindent = ' '.repeat(options.tabWidth)\n\t\t}\n\t}\n\tlet eol = doc.text.includes('\\r\\n') ? '\\r\\n' : '\\n';\n\n\tlet result = htmlPlugin.parsers.html.parse(doc.text, null, {} as ParserOptions)\n\tlet incrChars = 0;\n\tlet incrLines = 0;\n\tconst doFormat = (root) => {\n\t\tif (!root.children) return\n\t\tfor (let i = 0; i < root.children.length; i++) {\n\t\t\tconst node = root.children[i];\n\t\t\tif (node.type == 'element' && (node.name == 'script' || node.name == 'style')) {\n\t\t\t\tlet tagOffset = node.sourceSpan.start.offset;\n\t\t\t\tlet tagOffset2 = tagOffset;\n\t\t\t\twhile (tagOffset2 > -1) {\n\t\t\t\t\tif (doc.text[tagOffset2] == \"\\n\") {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\ttagOffset2--;\n\t\t\t\t}\n\t\t\t\tlet tagIndent = doc.text.slice(tagOffset2 + 1, tagOffset);\n\n\t\t\t\toptions.parser = node.name == 'script' ? 'babel' : 'css'\n\t\t\t\tlet child = node.children[0]\n\t\t\t\tlet ctext = '\\n'.repeat(child.sourceSpan.start.line + incrLines) + ' '.repeat(child.sourceSpan.start.col) + child.value; //keep the line and column for error tips\n\t\t\t\tctext = eol + format(ctext, options).trim().split(eol).map(line => tagIndent + indent + line).join(eol) + eol + tagIndent;\n\t\t\t\tconst start = child.sourceSpan.start.offset;\n\t\t\t\tdoc.text = doc.text.slice(0, start + incrChars) + ctext + doc.text.slice(start + child.value.length + incrChars);\n\t\t\t\tincrChars += ctext.length - child.value.length;\n\t\t\t\tincrLines += ctext.split('\\n').length - child.value.split('\\n').length;\n\t\t\t} else {\n\t\t\t\tdoFormat(node)\n\t\t\t}\n\t\t}\n\t}\n\tdoFormat(result);\n}", "import { Uri, workspace, ExtensionContext } from 'vscode';\n\nconst virtualDocumentContents = new Map<string, string>();\nconst virtualDocumentPaths = new Map<string, string>();\n\nexport interface ITextDocument {\n\turi: Uri | string;\n\tgetText(): string;\n}\n\nworkspace.registerTextDocumentContentProvider('dj-embedded-content', {\n\tprovideTextDocumentContent: uri => {\n\t\tconst i = uri.path.lastIndexOf('/');\n\t\tconst originalUri = uri.path.slice(1).slice(0, i - 1);\n\t\tconst decodedUri = decodeURIComponent(originalUri);\n\t\treturn virtualDocumentContents.get(decodedUri);\n\t}\n});\n\nexport function registerTextDocumentEvents(context: ExtensionContext, languageIds: string[]) {\n\tcontext.subscriptions.push(workspace.onDidChangeTextDocument(event => {\n\t\tif (languageIds.includes(event.document.languageId)) {\n\t\t\tvirtualDocumentPaths.delete(event.document.uri.toString());\n\t\t}\n\t}));\n\tcontext.subscriptions.push(workspace.onDidCloseTextDocument(doc => {\n\t\tif (doc.languageId == 'html') {\n\t\t\tvirtualDocumentContents.delete(doc.uri.toString());\n\t\t}\n\t}));\n\tcontext.subscriptions.push(workspace.onDidRenameFiles(event => {\n\t\tevent.files.forEach(f => {\n\t\t\tvirtualDocumentContents.delete(f.oldUri.toString());\n\t\t});\n\t}));\n}\n\nexport function createVirtualDoc(document: ITextDocument, languageId?: string) {\n\tlanguageId = languageId ?? \"html\";\n\tlet originalUri = document.uri.toString();\n\tif (languageId != \"html\") {\n\t\toriginalUri += \".\" + languageId;\n\t}\n\n\tvirtualDocumentContents.set(originalUri, document.getText());\n\n\t// const vdocUriString = `dj-embedded-content://django-html/${encodeURIComponent(originalUri)}.html`;\n\tlet path: string;\n\tif (virtualDocumentPaths.has(originalUri)) {\n\t\tpath = virtualDocumentPaths.get(originalUri);\n\t} else {\n\t\tpath = `/${encodeURIComponent(originalUri)}/${Math.random()}.${languageId}`;\n\t\tvirtualDocumentPaths.set(originalUri, path);\n\t}\n\t// random uri, as hoverProvide may cache hover info by uri\n\treturn Uri.from({\n\t\tscheme: 'dj-embedded-content',\n\t\tauthority: 'django-html',\n\t\tpath: path\n\t});\n}\n\nexport function clearVirtualDocumentContents() {\n\tvirtualDocumentContents.clear();\n}"],
  "mappings": "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",
  "names": []
}
